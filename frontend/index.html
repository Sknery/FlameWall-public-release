<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="build-version" content="__BUILD_VERSION__" />
  <meta name="theme-color" content="#121212">
  <title>FlameWall</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
  <div id="root"></div>

  <script>
    (async () => {
      if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.ready;
        if (registration && registration.active) {
          const htmlVersionMeta = document.querySelector('meta[name="build-version"]');
          const htmlVersion = htmlVersionMeta ? htmlVersionMeta.content : null;

          if (htmlVersion && htmlVersion !== '__BUILD_VERSION__') {
            try {
              const swVersion = await new Promise((resolve, reject) => {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = event => {
                  resolve(event.data);
                };
                setTimeout(() => reject(new Error('Service worker version request timed out.')), 1000);
                registration.active.postMessage({ type: 'GET_VERSION' }, [messageChannel.port2]);
              });
              if (htmlVersion !== swVersion) {
                console.warn(`[Updater] Mismatch detected! HTML: ${htmlVersion}, SW: ${swVersion}. Forcing update.`);
                await registration.unregister();
                window.location.reload();
              }
            } catch (error) {
              console.error('[Updater] Error checking service worker version:', error);
            }
          }
        }
      }
    })();
  </script>

  <script type="module" src="/src/index.jsx"></script>
</body>

</html>